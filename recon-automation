#!/usr/bin/env bash

set -euo pipefail

### Global settings ###
domain=""
output_dir=""



### Configuration ###
pd_tools=("subfinder" "shuffledns" "alterx" "dnsx" "naabu" "httpx" "katana" "urlfinder" "nuclei")




### Functions ###

# Check if script tools are isntalled.
check_script_tools() {
    printf "\n[INF] Checking if required tools are installed...\n"

    for tool in "${pd_tools[@]}"; do
        if command -v "$tool" &> /dev/null; then
            printf "[INF] $tool is already installed.\n"
            continue
        else
           printf "[WRN] $tool is not installed.\n"
        fi
    done
}

install_script_tools() {
    printf "[INF] Installing required tools...\n"

    (IFS=,
    pdtm -i "${pd_tools[*]}" -igp)
    
    if [[ $? -eq 0 ]]; then
        printf "[INF] All required tools were installed.\n"
    else
        printf "[ERR] Failed to install required tools.\n"
        return 1
    fi
}

# Define domain and output directory if unspecified.
define_variables() {

    while [[ -z "$domain" ]]; do
        read -e -r -p "Please specify a domain: " domain
        [[ -z  "$domain" ]] && printf "[ERR] $domain cannot be empty.\n"
    done

    local strip_protocol="${domain#*://}"
    local strip_name="${strip_protocol#www.}"
    local clean_name="${strip_name%%/*}"

    if [[ -n "$output_dir" && -d "$output_dir" ]]; then
       printf "[INF] Using existing directory: $output_dir.\n"
       return 0
    fi

    if [[ -z "$output_dir" ]]; then
        output_dir="$clean_name"
    fi

    if [[ ! -d "$output_dir" ]]; then
        mkdir -p "./$output_dir"
        printf "[INF] Output will be stored in: $output_dir.\n"
    else
        printf "[INF] Output will be stored in: $output_dir\n"
    fi
}

run_subfinder() {
    subfinder_out="$output_dir/subfinder_$(basename "$output_dir").txt"
    local subfinder_flags=(-d "$domain" -all -o "$subfinder_out" -silent)
    
    printf "\n[INF] Setting up Subfinder\n"
    printf "[INF] It is highly recommended to populate Subfinder's config file: (~/.config/subfinder/provider-config.yaml)\n"
    printf "      %s\n" "with API keys from various sources to enhance subdomain discovery."

    while true; do
        read -e -r -p "[!] Do you wish to configure it before running? (Y/n) " confirm
        case "$confirm" in
            [yY]*)
                printf "[!] Please populate you config file and write YES when you are done." 
                while true; do
                    read -e -r -p "Continue? " confirm
                    if [[ "$confirm" =~ ^[yY][eE][sS]$ ]]; then
                        break
                    else
                        printf "[!] Wrong option. Type YES to continue."
                    fi
                done
                break
                ;;
            [nN]*) 
                printf "[!] Continuing..."
                break
                ;;
            *) printf "[!] Wrong option. Select (y/n)" ;;
        esac
    done      

    printf "\n###############################################################\n"
    printf "##################### Starting Subfinder #####################\n"
    printf "###############################################################\n"

    subfinder "${subfinder_flags[@]}" &>/dev/null
    
    if [[ $? -eq 0 ]]; then
        local findings=$(wc -l <"$subfinder_out")
        printf "[INF] Subfinder done - $findings subdomains saved."
    else
        printf "[ERR] Subfinder failed."
        return 1
    fi
}

run_shuffledns() {
    local wordlist="${PWD}/wordlist.txt"
    local resolvers="${PWD}/resolvers.txt"
    shuffledns_out="$output_dir/shuffledns_$(basename "$output_dir").txt"
    local shuffledns_flags=(-d "$domain" -w "$wordlist" -r "$resolvers" -mode bruteforce -o "$shuffledns_out" -silent)

    printf "\n[INF] Setting up ShuffleDNS\n"
    printf "[INF] Shuffledns requires a public DNS resolvers list and curated bruteforcing wordlists for best results.\n"
    printf "      \n%s\n" "Recommended sources:"
    printf "   %s\n" "- Trickest  (Resolvers):  https://github.com/trickest/resolvers/blob/main/resolvers.txt"
    printf "   %s\n" "- SecLists  (Wordlists):  https://github.com/danielmiessler/SecLists"
    printf "   %s\n" "- AssetNote (Wordlists):  https://wordlists.assetnote.io"
    printf "\n[!] Download one and save as resolvers.txt in your working directory.\n"
    printf "[!] Download one and save as wordlist.txt in your working directory.\n\n"
    printf "[!] Enter YES when you are done.\n"

    while true; do
        read -e -r -p "[!] Ready to continue? " confirm
        if [[ "$confirm" =~ ^[yY][eE][sS]$ ]]; then
            if [[ ! -f "$wordlist" || ! -f "$resolvers" ]]; then
                printf "[ERR] Missing files! Ensure both wordlist.txt and resolvers.txt exist.\n"
                continue
            else
                break
            fi
        else
            continue
        fi
    done

    printf "\n###############################################################\n"
    printf "##################### Starting ShuffleDNS #####################\n"
    printf "###############################################################\n"

    printf "\n[INF] Starting ShuffleDNS\n"
    shuffledns "${shuffledns_flags[@]}" &>/dev/null

    if [[ $? -eq 0 ]]; then
        local findings=$(wc -l < "$shuffledns_out")
        printf "\n[INF] ShuffleDNS done - $findings subdomains saved.\n"
    else
        printf "[ERR] ShuffleDNS failed."
        return 1
    fi
}


# Configure AlterX
#set_alterx() {}

# Run AlterX
#run_alterx() {}

# Configure DNSX
#set_dnsx() {}

# Run DNSX
#run_dnsx() {}

# Configure Naabu
#set_naabu() {}

# Run Naabu
#run_naabu() {}

# Configure HTTPX
#set_httpx() {}

# Run HTTPX
#run_httpx() { }
# Configure Katana

#set_katana() {}

# Run Katana
#run_katana() {}

# Generate report
#generate_report() {}

##################
### Main Logic ###
##################

# Flags options
install_tools=()
verbose=false

while getopts ":i:vh" opt; do
    case $opt in
        i)
            if [[ "$OPTARG" == "tools" ]]; then
                install_tools+=("$OPTARG")
            else
                echo "Error: Invalid argument for -i. Use 'tools'." >&2
            fi
            ;;
        v) verbose=true ;;
        h)
            echo "Usage: $0 [-i pdmt] [-i tools] [-v verbose] [-h help]"
            exit 0
            ;;
        *) 
            echo "Usage: $0 [-i pdmt] [-i tools] [-v verbose] [-h help]"
            exit 0
            ;;
        \?)
            echo "Invalid option: -$OPTARG" >&2
            exit 1
            ;;
    esac
done
shift $((OPTIND-1))

for task in "${install_tools[@]}"; do
    case "$task" in
        "tools")
            #echo -e "\n[INF] Starting tools installation..."
            check_script_tools
            install_script_tools
            ;;
    esac
done

[[ $verbose == true ]] && set -x

#### ------ Phase 1: Asset Discovery ------ ####

## Logo here
## Legal disclaimer here
## Initial instructions here

# Define domain and output directory
define_variables ||
    { echo "[DBG] Function define_variables failed."; exit 1; }

echo -e "\n#### ------ Phase 1: Asset Discovery ------ ####"
echo -e "  ### --- Step 1: Passive Enumeration --- ###\n"

# Configure and run Subfinder
run_subfinder "$domain" "$output_dir" || { echo "[DBG] Subfinder failed."; exit 1; }

# Configure and run AlterX

# Configure and run DNSX

# Configure and run ShuffleDNS

# Configure and run Naabu
#echo "[WRN] This scan is active / Noisy"

#### ------ Phase 2: Content Discovery ---- ####

# Configure and run HTTPX

# Configure and run Katana
#echo "[WRN] This scan is active / Noisy"

# Consider run URLFinder with Katana to gather URLs from external sources

#### ------ Phase 3: Report Generation ------ ####

# Generate report

